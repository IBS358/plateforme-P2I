<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connexion | P2I</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
body{
background:linear-gradient(135deg,#0d1b2a 0%,#1b263b 100%);
color:white;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
.auth-container{
background:rgba(27,38,59,.85);backdrop-filter:blur(15px);
padding:40px;border-radius:25px;border:1px solid rgba(76,201,240,.2);
width:100%;max-width:450px;box-shadow:0 20px 50px rgba(0,0,0,.5)}
.auth-header{text-align:center;margin-bottom:30px}
.auth-header h2{
font-size:2rem;background:linear-gradient(to right,#4cc9f0,#f72585);
-webkit-background-clip:text;background-clip:text;color:transparent}
.role-badge{
display:inline-block;padding:5px 15px;background:rgba(76,201,240,.1);
border:1px solid #4cc9f0;border-radius:20px;font-size:.8rem;color:#4cc9f0;margin-top:10px}
.form-group{margin-bottom:20px}
label{display:block;margin-bottom:8px;color:#b8c1ec;font-size:.9rem}
input{
width:100%;padding:12px 15px;background:rgba(255,255,255,.05);
border:1px solid rgba(255,255,255,.1);border-radius:10px;color:white}
input:focus{border-color:#4cc9f0;background:rgba(255,255,255,.1);outline:none}
.btn-auth{
width:100%;padding:15px;background:linear-gradient(to right,#4cc9f0,#4361ee);
border:none;border-radius:12px;color:white;font-weight:700;font-size:1rem;cursor:pointer;margin-top:10px}
.error-msg{color:#f72585;font-size:.85rem;margin-top:10px;text-align:center;display:none}
.success-msg{color:#4cc9f0;font-size:.85rem;margin-top:10px;text-align:center;display:none}
.loading-spinner{
display:none;margin:10px auto;border:3px solid rgba(255,255,255,.1);
border-top:3px solid #4cc9f0;border-radius:50%;width:24px;height:24px;
animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.switch-mode{text-align:center;margin-top:20px;font-size:.9rem;color:#b8c1ec}
.switch-mode span{color:#4cc9f0;cursor:pointer;font-weight:600}
</style>
</head>

<body>

<div class="auth-container">
<div class="auth-header">
<h2 id="formTitle">Connexion</h2>
<div id="roleDisplay" class="role-badge">Profil</div>
</div>

<form id="authForm" novalidate>
<div class="form-group">
<label>Email</label>
<input type="email" id="email" placeholder="votre@email.com">
</div>

<div class="form-group">
<label>Mot de passe</label>
<input type="password" id="password" placeholder="••••••••">
</div>

<button type="submit" class="btn-auth" id="submitBtn">Se connecter</button>

<div class="loading-spinner" id="spinner"></div>
<div id="errorDisplay" class="error-msg"></div>
<div id="successDisplay" class="success-msg"></div>
</form>

<div class="switch-mode">
<p id="toggleText">Pas encore de compte ? <span onclick="toggleMode()">S'inscrire</span></p>
</div>

<div style="text-align:center;margin-top:15px;">
<a href="index.html" style="color:#b8c1ec;text-decoration:none;font-size:.8rem;">← Retour à l'accueil</a>
</div>
</div>

<script>
/* ================= CONFIG SUPABASE ================= */
const SUPABASE_URL = 'https://cfbbpmxdtiuicaitssjp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmYmJwbXhkdGl1aWNhaXRzc2pwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MzQ5MjUsImV4cCI6MjA4NDQxMDkyNX0._wukYnxJ27JJgW_YTU_m88YKNBVzAQFpMjBP7t8zT18';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= STATE ================= */
let isLogin = true;
const params = new URLSearchParams(window.location.search);
const userRole = params.get('role') || 'user';
const redirectParam = params.get('redirect');
const idParam = params.get('id');

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded',()=>{
document.getElementById('roleDisplay').innerText =
userRole === 'entrepreneur' ? 'Mode Entrepreneur' : 'Mode Utilisateur';
});

/* ================= UI ================= */
function toggleMode(){
isLogin=!isLogin;
document.getElementById('formTitle').innerText = isLogin?'Connexion':'Inscription';
document.getElementById('submitBtn').innerText = isLogin?'Se connecter':'Créer mon compte';
document.getElementById('toggleText').innerHTML = isLogin ?
"Pas encore de compte ? <span onclick=\"toggleMode()\">S'inscrire</span>" :
"Déjà un compte ? <span onclick=\"toggleMode()\">Se connecter</span>";
hideMessages();
}

function showMessage(id,msg,isError=true){
const el=document.getElementById(id);
el.innerText=msg;
el.style.display='block';
el.style.color=isError?'#f72585':'#4cc9f0';
}

function hideMessages(){
document.getElementById('errorDisplay').style.display='none';
document.getElementById('successDisplay').style.display='none';
}

/* ================= AUTH ================= */
async function login(email,password){
const {data,error}=await sb.auth.signInWithPassword({email,password});
if(error) throw error;
return data.user;
}

async function signup(email,password){
if(password.length<6) throw new Error("Mot de passe trop court (min 6 caractères)");
const {data,error}=await sb.auth.signUp({
email,password,
options:{data:{role:userRole,created_at:new Date().toISOString()}}
});
if(error) throw error;
return data.user;
}

/* ================= REDIRECT ================= */
function redirectAfterAuth(){
if(redirectParam && idParam){
window.location.href=`fiche-production.html?id=${idParam}&redirect=${redirectParam}`;
}else{
window.location.href='dashboard.html';
}
}

/* ================= FORM ================= */
document.getElementById('authForm').addEventListener('submit',async(e)=>{
e.preventDefault();

hideMessages();

const email=document.getElementById('email').value.trim();
const password=document.getElementById('password').value;
const btn=document.getElementById('submitBtn');
const spinner=document.getElementById('spinner');

if(!email || !password){
showMessage('errorDisplay',"Tous les champs sont obligatoires");
return;
}

btn.disabled=true;
spinner.style.display='block';

try{
if(isLogin){
await login(email,password);
showMessage('successDisplay',"Connexion réussie",false);
setTimeout(redirectAfterAuth,800);
}else{
await signup(email,password);
await login(email,password);
showMessage('successDisplay',"Compte créé et connecté",false);
setTimeout(redirectAfterAuth,1000);
}
}catch(err){
console.error(err);
showMessage('errorDisplay',err.message);
}finally{
btn.disabled=false;
spinner.style.display='none';
}
});
</script>

</body>
</html>
